name: CI

on:
  push:
    tags:
      - "v*"

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cargo check
        run: cargo check --workspace
      - name: Dependency guard
        run: ./scripts/check-deps.sh
      - name: Cargo test
        run: cargo test --workspace
      - name: Cargo clippy
        run: cargo clippy --workspace -- -D warnings
      - name: OpenAPI drift check
        run: ./scripts/check-openapi.sh

  integration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Run integration tests
        run: ./scripts/run-ci-integration.sh

  coverage:
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Coverage
        run: ./scripts/check-coverage.sh
