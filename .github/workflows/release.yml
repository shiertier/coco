name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-13
            target: x86_64-apple-darwin
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Build coco-local
        run: cargo build -p coco-local --release --locked --target ${{ matrix.target }}
      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: ./scripts/package-local.sh "${{ github.ref_name }}" "${{ matrix.target }}" "target/${{ matrix.target }}/release"
      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: pwsh -File scripts/package-local.ps1 "${{ github.ref_name }}" "${{ matrix.target }}" "target/${{ matrix.target }}/release"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: coco-local-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Generate Homebrew and Scoop manifests
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          repo="${GITHUB_REPOSITORY}"
          linux="dist/coco-local-x86_64-unknown-linux-gnu/coco-local-${version}-x86_64-unknown-linux-gnu.tar.gz"
          mac_x86="dist/coco-local-x86_64-apple-darwin/coco-local-${version}-x86_64-apple-darwin.tar.gz"
          mac_arm="dist/coco-local-aarch64-apple-darwin/coco-local-${version}-aarch64-apple-darwin.tar.gz"
          windows="dist/coco-local-x86_64-pc-windows-msvc/coco-local-${version}-x86_64-pc-windows-msvc.zip"
          sha_linux="$(sha256sum "${linux}" | cut -d ' ' -f1)"
          sha_mac_x86="$(sha256sum "${mac_x86}" | cut -d ' ' -f1)"
          sha_mac_arm="$(sha256sum "${mac_arm}" | cut -d ' ' -f1)"
          sha_windows="$(sha256sum "${windows}" | cut -d ' ' -f1)"
          bash scripts/generate-homebrew-formula.sh "${version}" "${repo}" "${sha_linux}" "${sha_mac_x86}" "${sha_mac_arm}" "dist/homebrew/coco-local.rb"
          bash scripts/generate-scoop-manifest.sh "${version}" "${repo}" "${sha_windows}" "dist/scoop/coco-local.json"
      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*
