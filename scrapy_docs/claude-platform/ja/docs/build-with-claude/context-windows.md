# コンテキストウィンドウ

言語モデルが参照できるテキストの量とその生成方法を理解する

---

## コンテキストウィンドウの理解

「コンテキストウィンドウ」とは、言語モデルが新しいテキストを生成する際に参照できるテキストの全体量と、生成する新しいテキストを合わせたものを指します。これは言語モデルが学習した大規模なデータコーパスとは異なり、モデルの「ワーキングメモリ」を表しています。より大きなコンテキストウィンドウにより、モデルはより複雑で長いプロンプトを理解して応答できますが、より小さなコンテキストウィンドウはモデルが長いプロンプトを処理したり、長い会話を通じて一貫性を保つ能力を制限する可能性があります。

以下の図は、APIリクエストの標準的なコンテキストウィンドウの動作を示しています<sup>1</sup>：

![コンテキストウィンドウ図](/docs/images/context-window.svg)

_<sup>1</sup>[claude.ai](https://claude.ai/)などのチャットインターフェースの場合、コンテキストウィンドウは「先入れ先出し」のローリングシステムで設定することもできます。_

* **段階的なトークン蓄積：** 会話がターンを進むにつれて、各ユーザーメッセージとアシスタント応答がコンテキストウィンドウ内に蓄積されます。前のターンは完全に保持されます。
* **線形成長パターン：** コンテキスト使用量は各ターンで線形に増加し、前のターンは完全に保持されます。
* **200Kトークン容量：** 利用可能な総コンテキストウィンドウ（200,000トークン）は、会話履歴を保存し、Claudeから新しい出力を生成するための最大容量を表します。
* **入出力フロー：** 各ターンは以下で構成されます：
  - **入力フェーズ：** すべての前の会話履歴と現在のユーザーメッセージを含みます
  - **出力フェーズ：** テキスト応答を生成し、これが将来の入力の一部になります

## 拡張思考を使用したコンテキストウィンドウ

[拡張思考](/docs/ja/build-with-claude/extended-thinking)を使用する場合、思考に使用されるトークンを含むすべての入力トークンと出力トークンがコンテキストウィンドウ制限にカウントされます。ただし、マルチターン状況ではいくつかのニュアンスがあります。

思考予算トークンは`max_tokens`パラメータのサブセットであり、出力トークンとして請求され、レート制限にカウントされます。

ただし、前の思考ブロックはClaudeAPIによってコンテキストウィンドウ計算から自動的に削除され、モデルが後続のターンで「見る」会話履歴の一部ではなく、実際の会話コンテンツのためにトークン容量を保持します。

以下の図は、拡張思考が有効な場合の特殊なトークン管理を示しています：

![拡張思考を使用したコンテキストウィンドウ図](/docs/images/context-window-thinking.svg)

* **拡張思考の削除：** 拡張思考ブロック（濃い灰色で表示）は各ターンの出力フェーズ中に生成されますが、**後続のターンの入力トークンとして転送されません**。思考ブロックを自分で削除する必要はありません。Claude APIが会話履歴の一部として返された場合、自動的にこれを行います。
* **技術実装の詳細：**
  - APIは、会話履歴の一部として返された場合、前のターンの思考ブロックを自動的に除外します。
  - 拡張思考トークンは、生成中に1回だけ出力トークンとして請求されます。
  - 有効なコンテキストウィンドウ計算は以下のようになります：`context_window = (input_tokens - previous_thinking_tokens) + current_turn_tokens`。
  - 思考トークンには`thinking`ブロックと`redacted_thinking`ブロックの両方が含まれます。

このアーキテクチャはトークン効率的であり、思考ブロックは実質的な長さを持つことができるため、トークン浪費なしで広範な推論を可能にします。

<Note>
コンテキストウィンドウと拡張思考の詳細については、[拡張思考ガイド](/docs/ja/build-with-claude/extended-thinking)をご覧ください。
</Note>

## 拡張思考とツール使用を使用したコンテキストウィンドウ

以下の図は、拡張思考とツール使用を組み合わせた場合のコンテキストウィンドウトークン管理を示しています：

![拡張思考とツール使用を使用したコンテキストウィンドウ図](/docs/images/context-window-thinking-tools.svg)

<Steps>
  <Step title="最初のターンアーキテクチャ">
    - **入力コンポーネント：** ツール構成とユーザーメッセージ
    - **出力コンポーネント：** 拡張思考+テキスト応答+ツール使用リクエスト
    - **トークン計算：** すべての入力および出力コンポーネントがコンテキストウィンドウにカウントされ、すべての出力コンポーネントが出力トークンとして請求されます。
  </Step>
  <Step title="ツール結果の処理（ターン2）">
    - **入力コンポーネント：** 最初のターンのすべてのブロックと`tool_result`。拡張思考ブロック**は**対応するツール結果と一緒に返される**必要があります**。これは思考ブロックを返す**必要がある**唯一のケースです。
    - **出力コンポーネント：** ツール結果がClaudeに返された後、Claudeはテキストのみで応答します（次の`user`メッセージまで追加の拡張思考はありません）。
    - **トークン計算：** すべての入力および出力コンポーネントがコンテキストウィンドウにカウントされ、すべての出力コンポーネントが出力トークンとして請求されます。
  </Step>
  <Step title="3番目のステップ">
    - **入力コンポーネント：** すべての入力と前のターンの出力は、思考ブロックを除いて転送されます。思考ブロックはClaudeがツール使用サイクル全体を完了したため、この時点で削除できます。APIは返された場合、思考ブロックを自動的に削除するか、この段階で自分で削除することができます。これは次の`User`ターンを追加する場所でもあります。
    - **出力コンポーネント：** ツール使用サイクルの外に新しい`User`ターンがあるため、Claudeは新しい拡張思考ブロックを生成して続行します。
    - **トークン計算：** 前の思考トークンはコンテキストウィンドウ計算から自動的に削除されます。他のすべての前のブロックはトークンウィンドウの一部としてカウントされ、現在の`Assistant`ターンの思考ブロックはコンテキストウィンドウの一部としてカウントされます。
  </Step>
</Steps>

* **拡張思考を使用したツール使用の考慮事項：**
  - ツール結果を投稿する場合、その特定のツールリクエストに付随する完全な未修正の思考ブロック（署名/編集済み部分を含む）を含める必要があります。
  - 拡張思考を使用したツール使用の有効なコンテキストウィンドウ計算は以下のようになります：`context_window = input_tokens + current_turn_tokens`。
  - システムは暗号署名を使用して思考ブロックの真正性を検証します。ツール使用中に思考ブロックを保持しないと、Claudeの推論の連続性が破損する可能性があります。したがって、思考ブロックを変更すると、APIはエラーを返します。

<Note>
Claude 4モデルは[インターリーブ思考](/docs/ja/build-with-claude/extended-thinking#interleaved-thinking)をサポートしており、これによりClaudeはツール呼び出し間で考えることができ、ツール結果を受け取った後、より高度な推論を行うことができます。

Claude Sonnet 3.7はインターリーブ思考をサポートしていないため、非`tool_result`ユーザーターンの間に拡張思考とツール呼び出しのインターリーブはありません。

拡張思考を使用したツールの使用の詳細については、[拡張思考ガイド](/docs/ja/build-with-claude/extended-thinking#extended-thinking-with-tool-use)をご覧ください。
</Note>

## 1Mトークンコンテキストウィンドウ

Claude Sonnet 4および4.5は、1百万トークンのコンテキストウィンドウをサポートしています。この拡張コンテキストウィンドウにより、より大きなドキュメントを処理し、より長い会話を維持し、より広範なコードベースで作業できます。

<Note>
1Mトークンコンテキストウィンドウは現在、[使用層](/docs/ja/api/rate-limits)4の組織とカスタムレート制限を持つ組織のベータ版です。1MトークンコンテキストウィンドウはClaudeソネット4およびソネット4.5でのみ利用可能です。
</Note>

1Mトークンコンテキストウィンドウを使用するには、APIリクエストに`context-1m-2025-08-07`[ベータヘッダー](/docs/ja/api/beta-headers)を含めます：

<CodeGroup>

```python Python
from anthropic import Anthropic

client = Anthropic()

response = client.beta.messages.create(
    model="claude-sonnet-4-5",
    max_tokens=1024,
    messages=[
        {"role": "user", "content": "Process this large document..."}
    ],
    betas=["context-1m-2025-08-07"]
)
```

```typescript TypeScript
import Anthropic from '@anthropic-ai/sdk';

const anthropic = new Anthropic();

const msg = await anthropic.beta.messages.create({
  model: 'claude-sonnet-4-5',
  max_tokens: 1024,
  messages: [
    { role: 'user', content: 'Process this large document...' }
  ],
  betas: ['context-1m-2025-08-07']
});
```

```bash cURL
curl https://api.anthropic.com/v1/messages \
  -H "x-api-key: $ANTHROPIC_API_KEY" \
  -H "anthropic-version: 2023-06-01" \
  -H "anthropic-beta: context-1m-2025-08-07" \
  -H "content-type: application/json" \
  -d '{
    "model": "claude-sonnet-4-5",
    "max_tokens": 1024,
    "messages": [
      {"role": "user", "content": "Process this large document..."}
    ]
  }'
```

</CodeGroup>

**重要な考慮事項：**
- **ベータステータス：** これはベータ機能であり、変更の対象となります。機能と価格は将来のリリースで変更または削除される可能性があります。
- **使用層要件：** 1Mトークンコンテキストウィンドウは、[使用層](/docs/ja/api/rate-limits)4の組織とカスタムレート制限を持つ組織で利用可能です。下位層の組織は、この機能にアクセスするために使用層4に進める必要があります。
- **可用性：** 1Mトークンコンテキストウィンドウは現在、Claude API、[Microsoft Foundry](/docs/ja/build-with-claude/claude-in-microsoft-foundry)、[Amazon Bedrock](/docs/ja/build-with-claude/claude-on-amazon-bedrock)、および[Google CloudのVertex AI](/docs/ja/build-with-claude/claude-on-vertex-ai)で利用可能です。
- **価格：** 200Kトークンを超えるリクエストは、プレミアム料金（入力2倍、出力1.5倍の価格）で自動的に請求されます。詳細については、[価格ドキュメント](/docs/ja/about-claude/pricing#long-context-pricing)をご覧ください。
- **レート制限：** 長いコンテキストリクエストには専用のレート制限があります。詳細については、[レート制限ドキュメント](/docs/ja/api/rate-limits#long-context-rate-limits)をご覧ください。
- **マルチモーダルの考慮事項：** 大量の画像またはPDFを処理する場合、ファイルのトークン使用量が異なる可能性があることに注意してください。大きなプロンプトを大量の画像と組み合わせる場合、[リクエストサイズ制限](/docs/ja/api/overview#request-size-limits)に達する可能性があります。

## Claude Sonnet 4.5およびHaiku 4.5のコンテキスト認識

Claude Sonnet 4.5およびClaude Haiku 4.5は**コンテキスト認識**機能を備えており、これらのモデルが会話全体を通じて残りのコンテキストウィンドウ（つまり「トークン予算」）を追跡できます。これにより、Claudeは利用可能なスペースの量を理解することで、タスクを実行し、コンテキストをより効果的に管理できます。Claudeは、残りのトークン数を推測する必要があるのではなく、このコンテキストを正確に使用してタスクを最後まで継続するようにネイティブに訓練されています。モデルにとって、コンテキスト認識がないことは、時計なしで料理番組に参加するようなものです。Claude 4.5モデルは、モデルに残りのコンテキストについて明示的に通知することでこれを変更し、利用可能なトークンを最大限に活用できるようにします。

**動作方法：**

会話の開始時に、Claudeは総コンテキストウィンドウに関する情報を受け取ります：

```
<budget:token_budget>200000</budget:token_budget>
```

予算は200Kトークン（標準）、500Kトークン（Claude.ai Enterprise）、または1Mトークン（ベータ、適格な組織向け）に設定されます。

各ツール呼び出しの後、Claudeは残りの容量に関する更新を受け取ります：

```
<system_warning>Token usage: 35000/200000; 165000 remaining</system_warning>
```

この認識により、Claudeは作業に残っている容量を決定し、長時間実行されるタスクでより効果的な実行を可能にします。画像トークンはこれらの予算に含まれます。

**利点：**

コンテキスト認識は特に以下の場合に価値があります：
- 継続的な焦点が必要な長時間実行されるエージェントセッション
- 状態遷移が重要なマルチコンテキストウィンドウワークフロー
- 慎重なトークン管理が必要な複雑なタスク

コンテキスト認識を活用するためのプロンプトガイダンスについては、[Claude 4ベストプラクティスガイド](/docs/ja/build-with-claude/prompt-engineering/claude-4-best-practices#context-awareness-and-multi-window-workflows)をご覧ください。

## 新しいClaudeモデルでのコンテキストウィンドウ管理

新しいClaudeモデル（Claude Sonnet 3.7以降）では、プロンプトトークンと出力トークンの合計がモデルのコンテキストウィンドウを超える場合、システムはコンテキストを静かに切り詰めるのではなく、検証エラーを返します。この変更はより予測可能な動作を提供しますが、より慎重なトークン管理が必要です。

トークン使用量を計画し、コンテキストウィンドウ制限内に留まるようにするには、[トークンカウントAPI](/docs/ja/build-with-claude/token-counting)を使用して、Claudeに送信する前にメッセージが使用するトークン数を推定できます。

モデル別のコンテキストウィンドウサイズのリストについては、[モデル比較](/docs/ja/about-claude/models/overview#model-comparison-table)テーブルをご覧ください。

# 次のステップ
<CardGroup cols={2}>
  <Card title="モデル比較テーブル" icon="scales" href="/docs/ja/about-claude/models/overview#model-comparison-table">
    モデル別のコンテキストウィンドウサイズと入出力トークン価格のリストについては、モデル比較テーブルをご覧ください。
  </Card>
  <Card title="拡張思考の概要" icon="settings" href="/docs/ja/build-with-claude/extended-thinking">
    拡張思考の動作方法と、ツール使用やプロンプトキャッシングなどの他の機能と一緒に実装する方法の詳細をご覧ください。
  </Card>
</CardGroup>