# API использования и стоимости

Программно получайте доступ к данным об использовании API и стоимости вашей организации с помощью API администратора Usage & Cost.

---

<Tip>
**The Admin API is unavailable for individual accounts.** To collaborate with teammates and add members, set up your organization in **Console → Settings → Organization**.
</Tip>

API администратора Usage & Cost предоставляет программный и детальный доступ к историческим данным об использовании API и стоимости для вашей организации. Эти данные аналогичны информации, доступной на страницах [Usage](/usage) и [Cost](/cost) консоли Claude.

Этот API позволяет вам лучше отслеживать, анализировать и оптимизировать ваши реализации Claude:

* **Точное отслеживание использования:** Получайте точные подсчеты токенов и шаблоны использования вместо полагания только на подсчет токенов ответа
* **Согласование стоимости:** Сопоставляйте внутренние записи с выставлением счетов Anthropic для финансовых и бухгалтерских команд
* **Производительность продукта и улучшение:** Отслеживайте производительность продукта при измерении того, улучшили ли изменения в системе её, или установите оповещения
* **Оптимизация [ограничения скорости](/docs/ru/api/rate-limits) и [приоритетного уровня](/docs/ru/api/service-tiers#get-started-with-priority-tier):** Оптимизируйте функции, такие как [кэширование подсказок](/docs/ru/build-with-claude/prompt-caching) или конкретные подсказки, чтобы максимально использовать выделенную вам ёмкость, или приобретите выделенную ёмкость.
* **Расширенный анализ:** Выполняйте более глубокий анализ данных, чем доступно в консоли

<Check>
  **Требуется ключ Admin API**
  
  Этот API является частью [Admin API](/docs/ru/build-with-claude/administration-api). Эти конечные точки требуют ключ Admin API (начинающийся с `sk-ant-admin...`), который отличается от стандартных ключей API. Только члены организации с ролью администратора могут предоставить ключи Admin API через [консоль Claude](/settings/admin-keys).
</Check>

## Решения партнёров

Ведущие платформы наблюдаемости предлагают готовые интеграции для мониторинга использования и стоимости Claude API без написания пользовательского кода. Эти интеграции предоставляют панели управления, оповещения и аналитику, чтобы помочь вам эффективно управлять использованием API.

<CardGroup cols={3}>
  <Card title="CloudZero" icon="chart" href="https://docs.cloudzero.com/docs/connections-anthropic">
    Платформа облачной аналитики для отслеживания и прогнозирования затрат
  </Card>
  <Card title="Datadog" icon="chart" href="https://docs.datadoghq.com/integrations/anthropic/">
    Наблюдаемость LLM с автоматическим отслеживанием и мониторингом
  </Card>
  <Card title="Grafana Cloud" icon="chart" href="https://grafana.com/docs/grafana-cloud/monitor-infrastructure/integrations/integration-reference/integration-anthropic/">
    Интеграция без агента для простой наблюдаемости LLM с готовыми панелями управления и оповещениями
  </Card>
  <Card title="Honeycomb" icon="polygon" href="https://docs.honeycomb.io/integrations/anthropic-usage-monitoring/">
    Расширенные запросы и визуализация через OpenTelemetry
  </Card>
  <Card title="Vantage" icon="chart" href="https://docs.vantage.sh/connecting_anthropic">
    Платформа FinOps для наблюдаемости стоимости и использования LLM
  </Card>
</CardGroup>

## Быстрый старт

Получите ежедневное использование вашей организации за последние 7 дней:

```bash
curl "https://api.anthropic.com/v1/organizations/usage_report/messages?\
starting_at=2025-01-08T00:00:00Z&\
ending_at=2025-01-15T00:00:00Z&\
bucket_width=1d" \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"
```

<Tip>
  **Установите заголовок User-Agent для интеграций**
  
  Если вы создаёте интеграцию, установите заголовок User-Agent, чтобы помочь нам понять шаблоны использования:
  ```
  User-Agent: YourApp/1.0.0 (https://yourapp.com)
  ```
</Tip>

## API использования

Отслеживайте потребление токенов в вашей организации с детальными разбивками по модели, рабочей области и уровню обслуживания с помощью конечной точки `/v1/organizations/usage_report/messages`.

### Ключевые концепции

- **Временные интервалы**: Агрегируйте данные об использовании в фиксированные интервалы (`1m`, `1h` или `1d`)
- **Отслеживание токенов**: Измеряйте некэшированные входные, кэшированные входные, создание кэша и выходные токены
- **Фильтрация и группировка**: Фильтруйте по ключу API, рабочей области, модели, уровню обслуживания или контекстному окну и группируйте результаты по этим измерениям
- **Использование серверных инструментов**: Отслеживайте использование серверных инструментов, таких как веб-поиск

Для полных деталей параметров и схем ответов см. [справочник API использования](/docs/ru/api/admin-api/usage-cost/get-messages-usage-report).

### Базовые примеры

#### Ежедневное использование по модели

```bash
curl "https://api.anthropic.com/v1/organizations/usage_report/messages?\
starting_at=2025-01-01T00:00:00Z&\
ending_at=2025-01-08T00:00:00Z&\
group_by[]=model&\
bucket_width=1d" \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"
```

#### Почасовое использование с фильтрацией

```bash
curl "https://api.anthropic.com/v1/organizations/usage_report/messages?\
starting_at=2025-01-15T00:00:00Z&\
ending_at=2025-01-15T23:59:59Z&\
models[]=claude-sonnet-4-5-20250929&\
service_tiers[]=batch&\
context_window[]=0-200k&\
bucket_width=1h" \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"
```

#### Фильтруйте использование по ключам API и рабочим областям

```bash
curl "https://api.anthropic.com/v1/organizations/usage_report/messages?\
starting_at=2025-01-01T00:00:00Z&\
ending_at=2025-01-08T00:00:00Z&\
api_key_ids[]=apikey_01Rj2N8SVvo6BePZj99NhmiT&\
api_key_ids[]=apikey_01ABC123DEF456GHI789JKL&\
workspace_ids[]=wrkspc_01JwQvzr7rXLA5AGx3HKfFUJ&\
workspace_ids[]=wrkspc_01XYZ789ABC123DEF456MNO&\
bucket_width=1d" \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"
```

<Tip>
Чтобы получить ID ключей API вашей организации, используйте конечную точку [List API Keys](/docs/ru/api/admin-api/apikeys/list-api-keys).

Чтобы получить ID рабочих областей вашей организации, используйте конечную точку [List Workspaces](/docs/ru/api/admin-api/workspaces/list-workspaces) или найдите ID рабочих областей вашей организации в консоли Anthropic.
</Tip>

### Ограничения временной детализации

| Детализация | Ограничение по умолчанию | Максимальное ограничение | Вариант использования |
|-------------|---------------|---------------|----------|
| `1m` | 60 интервалов | 1440 интервалов | Мониторинг в реальном времени |
| `1h` | 24 интервала | 168 интервалов | Ежедневные шаблоны |
| `1d` | 7 интервалов | 31 интервал | Еженедельные/ежемесячные отчёты |

## API стоимости

Получайте разбивки стоимости на уровне обслуживания в USD с помощью конечной точки `/v1/organizations/cost_report`.

### Ключевые концепции

- **Валюта**: Все стоимости в USD, указанные как десятичные строки в наименьших единицах (центы)
- **Типы стоимости**: Отслеживайте стоимость использования токенов, веб-поиска и выполнения кода
- **Группировка**: Группируйте стоимость по рабочей области или описанию для детальных разбивок
- **Временные интервалы**: Только ежедневная детализация (`1d`)

Для полных деталей параметров и схем ответов см. [справочник API стоимости](/docs/ru/api/admin-api/usage-cost/get-cost-report).

<Warning>
  Стоимость приоритетного уровня использует другую модель выставления счетов и не включена в конечную точку стоимости. Отслеживайте использование приоритетного уровня через конечную точку использования.
</Warning>

### Базовый пример

```bash
curl "https://api.anthropic.com/v1/organizations/cost_report?\
starting_at=2025-01-01T00:00:00Z&\
ending_at=2025-01-31T00:00:00Z&\
group_by[]=workspace_id&\
group_by[]=description" \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"
```

## Постраничная навигация

Обе конечные точки поддерживают постраничную навигацию для больших наборов данных:

1. Сделайте ваш начальный запрос
2. Если `has_more` равно `true`, используйте значение `next_page` в вашем следующем запросе
3. Продолжайте, пока `has_more` не будет `false`

```bash
# Первый запрос
curl "https://api.anthropic.com/v1/organizations/usage_report/messages?\
starting_at=2025-01-01T00:00:00Z&\
ending_at=2025-01-31T00:00:00Z&\
limit=7" \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"

# Ответ включает: "has_more": true, "next_page": "page_xyz..."

# Следующий запрос с постраничной навигацией
curl "https://api.anthropic.com/v1/organizations/usage_report/messages?\
starting_at=2025-01-01T00:00:00Z&\
ending_at=2025-01-31T00:00:00Z&\
limit=7&\
page=page_xyz..." \
  --header "anthropic-version: 2023-06-01" \
  --header "x-api-key: $ADMIN_API_KEY"
```

## Распространённые варианты использования

Изучите детальные реализации в [anthropic-cookbook](https://github.com/anthropics/anthropic-cookbook):

- **Ежедневные отчёты об использовании**: Отслеживайте тренды потребления токенов
- **Атрибуция стоимости**: Распределяйте расходы по рабочей области для возмещения
- **Эффективность кэша**: Измеряйте и оптимизируйте кэширование подсказок
- **Мониторинг бюджета**: Установите оповещения для пороговых значений расходов
- **Экспорт CSV**: Создавайте отчёты для финансовых команд

## Часто задаваемые вопросы

### Насколько свежи данные?
Данные об использовании и стоимости обычно появляются в течение 5 минут после завершения запроса API, хотя задержки могут быть иногда дольше.

### Какая рекомендуемая частота опроса?
API поддерживает опрос один раз в минуту для постоянного использования. Для коротких всплесков (например, загрузка данных с постраничной навигацией) более частый опрос приемлем. Кэшируйте результаты для панелей управления, которым требуются частые обновления.

### Как отслеживать использование выполнения кода?
Стоимость выполнения кода появляется в конечной точке стоимости, сгруппированная под `Code Execution Usage` в поле описания. Выполнение кода не включено в конечную точку использования.

### Как отслеживать использование приоритетного уровня?
Фильтруйте или группируйте по `service_tier` в конечной точке использования и ищите значение `priority`. Стоимость приоритетного уровня недоступна в конечной точке стоимости.

### Что происходит с использованием Workbench?
Использование API из Workbench не связано с ключом API, поэтому `api_key_id` будет `null` даже при группировке по этому измерению.

### Как представлена рабочая область по умолчанию?
Использование и стоимость, отнесённые к рабочей области по умолчанию, имеют значение `null` для `workspace_id`.

### Как получить разбивки стоимости для каждого пользователя для Claude Code?

Используйте [API аналитики Claude Code](/docs/ru/build-with-claude/claude-code-analytics-api), который предоставляет предполагаемые стоимости для каждого пользователя и метрики производительности без ограничений производительности при разбивке стоимости по многим ключам API. Для общего использования API с многими ключами используйте [API использования](#usage-api) для отслеживания потребления токенов как прокси стоимости.

## См. также
API использования и стоимости можно использовать для улучшения опыта ваших пользователей, управления затратами и сохранения вашего ограничения скорости. Узнайте больше о некоторых из этих других функций:

- [Обзор Admin API](/docs/ru/build-with-claude/administration-api)
- [Справочник Admin API](/docs/ru/api/admin)
- [Цены](/docs/ru/about-claude/pricing)
- [Кэширование подсказок](/docs/ru/build-with-claude/prompt-caching) - Оптимизируйте стоимость с помощью кэширования
- [Пакетная обработка](/docs/ru/build-with-claude/batch-processing) - 50% скидка на пакетные запросы
- [Ограничения скорости](/docs/ru/api/rate-limits) - Понимайте уровни использования