services:
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: coco
      POSTGRES_PASSWORD: coco
      POSTGRES_DB: coco
    volumes:
      - coco_pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  qdrant:
    image: qdrant/qdrant:v1.9.0
    profiles:
      - qdrant
    ports:
      - "6333:6333"
    volumes:
      - coco_qdrant:/qdrant/storage

  coco-server:
    image: ${COCO_API_IMAGE:-coco-server}
    build:
      context: .
      dockerfile: Dockerfile.server
    environment:
      COCO_DB_URL: postgres://coco:coco@db:5432/coco
      # Set COCO_VECTOR_BACKEND=qdrant to use the qdrant profile.
      COCO_VECTOR_BACKEND: ${COCO_VECTOR_BACKEND:-pgvector}
      COCO_VECTOR_DB_URL: ${COCO_VECTOR_DB_URL:-http://qdrant:6333}
      COCO_VECTOR_DB_COLLECTION_PREFIX: ${COCO_VECTOR_DB_COLLECTION_PREFIX:-coco}
      COCO_ADMIN_KEY: admin
      COCO_API_KEY: api
      COCO_HOST: 0.0.0.0
      COCO_PORT: 3456
      COCO_OPENAI_API_KEY: ${COCO_OPENAI_API_KEY:-}
    depends_on:
      - db
    ports:
      - "3456:3456"

  coco-worker:
    image: ${COCO_WORKER_IMAGE:-coco-worker}
    build:
      context: .
      dockerfile: Dockerfile.worker
    environment:
      COCO_DB_URL: postgres://coco:coco@db:5432/coco
      # Set COCO_VECTOR_BACKEND=qdrant to use the qdrant profile.
      COCO_VECTOR_BACKEND: ${COCO_VECTOR_BACKEND:-pgvector}
      COCO_VECTOR_DB_URL: ${COCO_VECTOR_DB_URL:-http://qdrant:6333}
      COCO_VECTOR_DB_COLLECTION_PREFIX: ${COCO_VECTOR_DB_COLLECTION_PREFIX:-coco}
      COCO_WORKER_POLL_MS: 500
      COCO_WORKER_BATCH_SIZE: 256
      COCO_WORKER_MAX_ATTEMPTS: 3
      COCO_WORKER_RETRY_BACKOFF_MS: 500
    depends_on:
      - db

volumes:
  coco_pgdata:
  coco_qdrant:
