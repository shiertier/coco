# CoCo 代码改进计划

## 概述

基于 Linus Torvalds 风格的代码审查，本计划列出了针对 `coco-protocol` 和 `coco-core` 的具体改进措施。所有改进都遵循 Rust 最佳实践：简化所有权、消除重复代码、使用类型系统消除边缘情况。

## 改进优先级

### 高优先级（必须修复）
1. 消除 ID 类型的重复代码
2. 改进 CocoError 的错误链设计
3. 使用 AST 替代字符串匹配检测代码边界

### 中优先级（应该修复）
4. 提取验证函数中的重复逻辑
5. 简化 token_spans 函数逻辑
6. 改进 WasmGrammar 的所有权模型

### 低优先级（可以考虑）
7. 避免重复解析 Markdown
8. 评估 Trait 中的 RPITIT 设计

---

## 详细改进任务

### 任务 1：使用宏消除 ID 类型的重复代码

**目标**：消除 `ProjectId`, `DocumentId`, `ChunkId` 三个类型的重复实现。

**文件**：`crates/coco-protocol/src/lib.rs`

**步骤**：
1. 在文件开头定义宏 `impl_id_type!`
2. 使用宏生成三个 ID 类型的所有实现
3. 删除手写的重复代码
4. 运行测试确保功能不变

**预期结果**：
- 代码行数减少约 150 行
- 修改 ID 类型行为时只需修改宏定义
- 保持所有现有功能和测试通过

---

### 任务 2：改进 CocoError 的错误链设计

**目标**：改进 `CocoError` 的 source 字段设计，保留原始错误类型信息。

**文件**：`crates/coco-protocol/src/lib.rs`

**步骤**：
1. 修改 `CocoErrorSource` 结构体，使其存储 `Box<dyn std::error::Error + Send + Sync>`
2. 更新 `CocoError` 枚举，使用 `#[source]` 属性
3. 更新所有创建 `CocoError` 的方法
4. 运行测试确保错误链正确工作

**预期结果**：
- 错误链保留原始错误类型
- 可以使用 `error.source()` 向上遍历错误链
- 保持与现有 API 的兼容性

---

### 任务 3：使用 AST 替代字符串匹配检测代码边界

**目标**：改进 `CodeSplitter` 的边界检测逻辑，使用 Tree-sitter AST 而不是字符串匹配。

**文件**：`crates/coco-core/src/code.rs`

**步骤**：
1. 为每种语言定义 Tree-sitter 查询
2. 使用 AST 查询识别函数、类、结构等边界
3. 替换 `is_rust_boundary`, `is_python_boundary` 等函数
4. 更新测试以验证新的边界检测逻辑
5. 性能测试确保没有显著退化

**预期结果**：
- 更准确的代码边界检测
- 减少假阳性和假阴性
- 更好的可维护性（AST 查询比字符串匹配更清晰）

---

### 任务 4：提取验证函数中的重复逻辑

**目标**：提取公共验证逻辑到辅助函数。

**文件**：`crates/coco-protocol/src/lib.rs`

**步骤**：
1. 创建辅助函数 `validate_top_k(top_k: u32) -> CocoResult<()>`
2. 创建辅助函数 `validate_hybrid_alpha(alpha: f32) -> CocoResult<()>`
3. 更新 `validate_indexing_config` 和 `validate_retrieval_config` 使用这些辅助函数
4. 更新测试确保验证逻辑不变

**预期结果**：
- 减少重复代码
- 验证逻辑集中在一处，易于维护
- 保持所有现有功能和测试通过

---

### 任务 5：简化 token_spans 函数逻辑

**目标**：使用迭代器组合器简化 `token_spans` 函数。

**文件**：`crates/coco-core/src/text.rs`

**步骤**：
1. 使用 `split_whitespace()` 和 `scan()` 组合器重写 `token_spans`
2. 确保新实现处理所有边缘情况
3. 更新测试验证新实现
4. 性能对比确保没有退化

**预期结果**：
- 更简洁、更易读的代码
- 减少手动状态机的复杂性
- 保持性能和功能

---

### 任务 6：改进 WasmGrammar 的所有权模型

**目标**：改进 `WasmGrammar` 的所有权模型，支持运行时修改 store 状态。

**文件**：`crates/coco-core/src/wasm.rs`

**步骤**：
1. 评估当前 API 的使用场景
2. 如果需要运行时修改，提供可变访问 store 的方法
3. 或者重新设计 API 以支持运行时配置
4. 更新测试和文档

**预期结果**：
- 支持运行时动态调整 WASM 实例行为
- 保持类型安全和借用检查器友好
- 清晰的 API 文档说明所有权语义

---

### 任务 7：避免重复解析 Markdown

**目标**：避免 `MarkdownParser` 和 `MarkdownSplitter` 重复解析内容。

**文件**：`crates/coco-core/src/markdown.rs`

**步骤**：
1. 设计 API 以支持重用解析结果
2. 或者将解析和分割合并到一个操作中
3. 更新使用这些类型的代码
4. 更新测试

**预期结果**：
- 减少 CPU 使用
- 更清晰的 API 设计
- 保持功能不变

---

### 任务 8：评估 Trait 中的 RPITIT 设计

**目标**：评估 `StorageBackend`, `VectorStore` 等 Trait 中的 RPITIT 设计是否合适。

**文件**：`crates/coco-protocol/src/lib.rs`

**步骤**：
1. 评估当前 RPITIT 设计的优缺点
2. 考虑是否需要支持不同的异步运行时
3. 如果需要，考虑使用关联类型或其他方案
4. 更新文档说明设计决策

**预期结果**：
- 清晰的设计决策文档
- 如果需要，提供替代方案
- 保持当前 API 的稳定性

---

## 测试策略

每个改进任务都应该：

1. **运行现有测试**：确保改进不破坏现有功能
2. **添加新测试**：覆盖新的代码路径
3. **性能测试**：确保改进不会导致性能退化
4. **Clippy 检查**：确保代码符合 Rust 最佳实践
5. **文档更新**：更新相关文档

---

## 实施顺序

建议按以下顺序实施改进：

1. **任务 1**（ID 类型宏）- 独立，风险低
2. **任务 4**（验证函数）- 独立，风险低
3. **任务 2**（错误链）- 独立，中等风险
4. **任务 5**（token_spans）- 独立，中等风险
5. **任务 3**（AST 边界）- 依赖 Tree-sitter，高风险
6. **任务 6**（WasmGrammar）- 需要评估使用场景
7. **任务 7**（Markdown 解析）- 需要评估使用场景
8. **任务 8**（RPITIT 评估）- 架构决策

---

## 风险评估

| 任务 | 风险等级 | 风险描述 |
|------|-----------|-----------|
| 任务 1 | 低 | 纯重构，不改变功能 |
| 任务 2 | 中 | 改变错误类型，可能影响错误处理代码 |
| 任务 3 | 高 | 改变核心逻辑，需要大量测试 |
| 任务 4 | 低 | 纯重构，不改变功能 |
| 任务 5 | 中 | 改变算法，需要性能测试 |
| 任务 6 | 中 | 改变 API，需要评估使用场景 |
| 任务 7 | 中 | 改变 API，需要评估使用场景 |
| 任务 8 | 低 | 评估和文档，不改变代码 |

---

## 成功标准

每个改进任务完成后，应该满足：

1. ✅ 所有现有测试通过
2. ✅ 新测试覆盖新的代码路径
3. ✅ Clippy 检查通过（无警告）
4. ✅ 代码审查通过
5. ✅ 文档更新完成
6. ✅ 性能测试显示无退化

---

## 后续步骤

完成所有改进任务后：

1. 运行完整的测试套件：`cargo test --workspace`
2. 运行 Clippy 检查：`cargo clippy --workspace -- -D warnings`
3. 更新项目文档
4. 创建改进总结文档
5. 评估是否需要进一步的改进